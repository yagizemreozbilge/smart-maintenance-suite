        -:    0:Source:src/backend/tests/unit/database/test_alert_service_real.c
        -:    0:Graph:build_backend_tests/test_alert_service_real-test_alert_service_real.gcno
        -:    0:Data:build_backend_tests/test_alert_service_real-test_alert_service_real.gcda
        -:    0:Runs:1
        -:    1:#include <stdarg.h>
        -:    2:#include <stddef.h>
        -:    3:#include <setjmp.h>
        -:    4:#include <cmocka.h>
        -:    5:#include <string.h>
        -:    6:#include <stdio.h>
        -:    7:#include <stdlib.h>
        -:    8:
        -:    9:// PostgreSQL'i tamamen devre dışı bırak
        -:   10:#define LIBPQ_FE_H
        -:   11:#define PQconninfoOption void
        -:   12:#define PGconn void
        -:   13:#define PGresult void
        -:   14:#define ConnStatusType int
        -:   15:#define ExecStatusType int
        -:   16:#define CONNECTION_OK 0
        -:   17:#define CONNECTION_BAD 1
        -:   18:#define PGRES_COMMAND_OK 1
        -:   19:#define PGRES_TUPLES_OK 2
        -:   20:#define PGRES_FATAL_ERROR 3
        -:   21:
        -:   22:// Header dosyaları - sıra önemli!
        -:   23:#include "alert_service.h"
        -:   24:#include "db_connection.h"
        -:   25:
        -:   26:// Logger mock'ları
function LOG_INFO called 0 returned 0% blocks executed 0%
    #####:   27:void LOG_INFO(const char *format, ...) {}
function LOG_ERROR called 0 returned 0% blocks executed 0%
    #####:   28:void LOG_ERROR(const char *format, ...) {}
        -:   29:
        -:   30:/* ====================================================================
        -:   31: * MOCK FONKSİYONLAR
        -:   32: * ==================================================================== */
        -:   33:
        -:   34:static DBConnection mock_conn;
        -:   35:static void* mock_result;
        -:   36:static int mock_acquire_success = 1;
        -:   37:static int mock_result_status = PGRES_COMMAND_OK;
        -:   38:static char mock_error_message[256] = "";
        -:   39:static char mock_query[1024] = "";
        -:   40:
        -:   41:static int mock_acquire_called = 0;
        -:   42:static int mock_release_called = 0;
        -:   43:static int mock_pqexec_called = 0;
        -:   44:static int mock_pqclear_called = 0;
        -:   45:
        -:   46:typedef struct {
        -:   47:    char id[10];
        -:   48:    char sensor_id[10];
        -:   49:    char severity[20];
        -:   50:    char message[256];
        -:   51:    char created_at[32];
        -:   52:} MockRow;
        -:   53:
        -:   54:static MockRow mock_rows[10];
        -:   55:static int mock_row_count = 0;
        -:   56:
function db_pool_acquire called 6 returned 100% blocks executed 100%
        6:   57:DBConnection* db_pool_acquire(void) {
        6:   58:    mock_acquire_called++;
        6:   59:    if (mock_acquire_success) {
branch  0 taken 5 (fallthrough)
branch  1 taken 1
        5:   60:        mock_conn.pg_conn = (void*)0x1234;
        5:   61:        return &mock_conn;
        -:   62:    }
        1:   63:    return NULL;
        -:   64:}
        -:   65:
function db_pool_release called 5 returned 100% blocks executed 100%
        5:   66:void db_pool_release(DBConnection *conn) {
        5:   67:    mock_release_called++;
        5:   68:}
        -:   69:
function PQexec called 5 returned 100% blocks executed 100%
        5:   70:void* PQexec(void* conn, const char *query) {
        5:   71:    mock_pqexec_called++;
        5:   72:    if (query) strncpy(mock_query, query, sizeof(mock_query) - 1);
branch  0 taken 5 (fallthrough)
branch  1 taken 0
        5:   73:    return mock_result;
        -:   74:}
        -:   75:
function PQresultStatus called 5 returned 100% blocks executed 100%
        5:   76:int PQresultStatus(const void *res) {
        5:   77:    return mock_result_status;
        -:   78:}
        -:   79:
function PQerrorMessage called 1 returned 100% blocks executed 100%
        1:   80:char* PQerrorMessage(const void *conn) {
        1:   81:    return mock_error_message;
        -:   82:}
        -:   83:
function PQclear called 5 returned 100% blocks executed 100%
        5:   84:void PQclear(void *res) {
        5:   85:    mock_pqclear_called++;
        5:   86:}
        -:   87:
function PQntuples called 2 returned 100% blocks executed 100%
        2:   88:int PQntuples(const void *res) {
        2:   89:    return mock_row_count;
        -:   90:}
        -:   91:
function PQgetvalue called 10 returned 100% blocks executed 89%
       10:   92:char* PQgetvalue(const void *res, int row, int field) {
       10:   93:    if (row < mock_row_count) {
branch  0 taken 10 (fallthrough)
branch  1 taken 0
       10:   94:        switch (field) {
branch  0 taken 2
branch  1 taken 2
branch  2 taken 2
branch  3 taken 2
branch  4 taken 2
branch  5 taken 0
        2:   95:            case 0: return mock_rows[row].id;
        2:   96:            case 1: return mock_rows[row].sensor_id;
        2:   97:            case 2: return mock_rows[row].severity;
        2:   98:            case 3: return mock_rows[row].message;
        2:   99:            case 4: return mock_rows[row].created_at;
        -:  100:        }
        -:  101:    }
    #####:  102:    return "";
        -:  103:}
        -:  104:
        -:  105:/* ====================================================================
        -:  106: * TEST SETUP
        -:  107: * ==================================================================== */
        -:  108:
function reset_mocks called 7 returned 100% blocks executed 100%
        7:  109:static void reset_mocks(void) {
        7:  110:    mock_acquire_success = 1;
        7:  111:    mock_result_status = PGRES_COMMAND_OK;
        7:  112:    mock_error_message[0] = '\0';
        7:  113:    mock_query[0] = '\0';
        7:  114:    mock_acquire_called = 0;
        7:  115:    mock_release_called = 0;
        7:  116:    mock_pqexec_called = 0;
        7:  117:    mock_pqclear_called = 0;
        7:  118:    mock_row_count = 0;
        7:  119:    memset(mock_rows, 0, sizeof(mock_rows));
        7:  120:}
        -:  121:
        -:  122:/* ====================================================================
        -:  123: * TEST CASES
        -:  124: * ==================================================================== */
        -:  125:
function test_create_alert_success called 1 returned 100% blocks executed 100%
        1:  126:static void test_create_alert_success(void **state) {
        1:  127:    reset_mocks();
call    0 returned 1
        -:  128:    
        1:  129:    bool result = create_alert(1, 2, "Test message");
call    0 returned 1
        -:  130:    
        1:  131:    assert_true(result);
call    0 returned 1
        1:  132:    assert_int_equal(mock_acquire_called, 1);
call    0 returned 1
        1:  133:    assert_int_equal(mock_pqexec_called, 1);
call    0 returned 1
        1:  134:    assert_int_equal(mock_pqclear_called, 1);
call    0 returned 1
        1:  135:    assert_int_equal(mock_release_called, 1);
call    0 returned 1
        1:  136:}
        -:  137:
function test_create_alert_acquire_fails called 1 returned 100% blocks executed 100%
        1:  138:static void test_create_alert_acquire_fails(void **state) {
        1:  139:    reset_mocks();
call    0 returned 1
        1:  140:    mock_acquire_success = 0;
        -:  141:    
        1:  142:    bool result = create_alert(1, 2, "Test");
call    0 returned 1
        1:  143:    assert_false(result);
call    0 returned 1
        1:  144:}
        -:  145:
function test_create_alert_db_error called 1 returned 100% blocks executed 100%
        1:  146:static void test_create_alert_db_error(void **state) {
        1:  147:    reset_mocks();
call    0 returned 1
        1:  148:    mock_result_status = PGRES_FATAL_ERROR;
        -:  149:    
        1:  150:    bool result = create_alert(1, 2, "Test");
call    0 returned 1
        1:  151:    assert_false(result);
call    0 returned 1
        1:  152:}
        -:  153:
function test_check_temperature_critical called 1 returned 100% blocks executed 100%
        1:  154:static void test_check_temperature_critical(void **state) {
        1:  155:    reset_mocks();
call    0 returned 1
        -:  156:    
        1:  157:    check_and_trigger_alerts(1, "Temperature", 95.5);
call    0 returned 1
        1:  158:    assert_int_equal(mock_pqexec_called, 1);
call    0 returned 1
        1:  159:}
        -:  160:
function test_check_temperature_normal called 1 returned 100% blocks executed 100%
        1:  161:static void test_check_temperature_normal(void **state) {
        1:  162:    reset_mocks();
call    0 returned 1
        -:  163:    
        1:  164:    check_and_trigger_alerts(1, "Temperature", 70.0);
call    0 returned 1
        1:  165:    assert_int_equal(mock_pqexec_called, 0);
call    0 returned 1
        1:  166:}
        -:  167:
function test_get_recent_alerts_success called 1 returned 100% blocks executed 100%
        1:  168:static void test_get_recent_alerts_success(void **state) {
        1:  169:    reset_mocks();
call    0 returned 1
        1:  170:    mock_result_status = PGRES_TUPLES_OK;
        1:  171:    mock_row_count = 2;
        -:  172:    
        1:  173:    strcpy(mock_rows[0].id, "1");
        1:  174:    strcpy(mock_rows[0].sensor_id, "101");
        1:  175:    strcpy(mock_rows[0].severity, "CRITICAL");
        1:  176:    strcpy(mock_rows[0].message, "Test1");
        1:  177:    strcpy(mock_rows[0].created_at, "2024-01-01");
        -:  178:    
        1:  179:    strcpy(mock_rows[1].id, "2");
        1:  180:    strcpy(mock_rows[1].sensor_id, "102");
        1:  181:    strcpy(mock_rows[1].severity, "WARNING");
        1:  182:    strcpy(mock_rows[1].message, "Test2");
        1:  183:    strcpy(mock_rows[1].created_at, "2024-01-02");
        -:  184:    
        -:  185:    AlertInfo alerts[5];
        1:  186:    int count = get_recent_alerts(alerts, 5);
call    0 returned 1
        -:  187:    
        1:  188:    assert_int_equal(count, 2);
call    0 returned 1
        1:  189:    assert_int_equal(alerts[0].id, 1);
call    0 returned 1
        1:  190:}
        -:  191:
function test_get_recent_alerts_empty called 1 returned 100% blocks executed 100%
        1:  192:static void test_get_recent_alerts_empty(void **state) {
        1:  193:    reset_mocks();
call    0 returned 1
        1:  194:    mock_result_status = PGRES_TUPLES_OK;
        1:  195:    mock_row_count = 0;
        -:  196:    
        -:  197:    AlertInfo alerts[5];
        1:  198:    int count = get_recent_alerts(alerts, 5);
call    0 returned 1
        1:  199:    assert_int_equal(count, 0);
call    0 returned 1
        1:  200:}
        -:  201:
        -:  202:/* ====================================================================
        -:  203: * MAIN
        -:  204: * ==================================================================== */
        -:  205:
function main called 1 returned 100% blocks executed 100%
        1:  206:int main(void) {
        1:  207:    const struct CMUnitTest tests[] = {
        -:  208:        cmocka_unit_test(test_create_alert_success),
        -:  209:        cmocka_unit_test(test_create_alert_acquire_fails),
        -:  210:        cmocka_unit_test(test_create_alert_db_error),
        -:  211:        cmocka_unit_test(test_check_temperature_critical),
        -:  212:        cmocka_unit_test(test_check_temperature_normal),
        -:  213:        cmocka_unit_test(test_get_recent_alerts_success),
        -:  214:        cmocka_unit_test(test_get_recent_alerts_empty),
        -:  215:    };
        -:  216:    
        1:  217:    return cmocka_run_group_tests(tests, NULL, NULL);
call    0 returned 1
        -:  218:}
