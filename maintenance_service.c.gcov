        -:    0:Source:src/backend/database/maintenance_service.c
        -:    0:Graph:build_backend_tests/test_maintenance_service_real-maintenance_service.gcno
        -:    0:Data:build_backend_tests/test_maintenance_service_real-maintenance_service.gcda
        -:    0:Runs:1
        -:    1:#include "maintenance_service.h"
        -:    2:#include "db_connection.h"
        -:    3:#include "logger.h"
        -:    4:#include <stdio.h>
        -:    5:#include <stdlib.h>
        -:    6:#include <string.h>
        -:    7:
        -:    8:#ifndef TEST_MODE
        -:    9:
function add_maintenance_log called 0 returned 0% blocks executed 0%
    #####:   10:bool add_maintenance_log(int machine_id, const char *technician, const char *description, double cost) {
    #####:   11:    DBConnection *conn_wrapper = db_pool_acquire();
call    0 never executed
        -:   12:    
    #####:   13:    if (!conn_wrapper) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:   14:        LOG_ERROR("Could not acquire connection to add maintenance log.");
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
    #####:   15:        return false;
        -:   16:    }
        -:   17:    
        -:   18:    char query[1024];
    #####:   19:    snprintf(query, sizeof(query),
call    0 never executed
        -:   20:             "INSERT INTO maintenance_logs (machine_id, performer, description, cost) "
        -:   21:             "VALUES (%d, '%s', '%s', %.2f);",
        -:   22:             machine_id, technician, description, cost);
    #####:   23:    PGresult *res = PQexec(conn_wrapper->pg_conn, query);
call    0 never executed
        -:   24:    
    #####:   25:    if (PQresultStatus(res) != PGRES_COMMAND_OK) {
call    0 never executed
branch  1 never executed (fallthrough)
branch  2 never executed
    #####:   26:        LOG_ERROR("Failed to insert maintenance log: %s", PQerrorMessage(conn_wrapper->pg_conn));
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
call    4 never executed
    #####:   27:        PQclear(res);
call    0 never executed
    #####:   28:        db_pool_release(conn_wrapper);
call    0 never executed
    #####:   29:        return false;
        -:   30:    }
        -:   31:    
    #####:   32:    PQclear(res);
call    0 never executed
    #####:   33:    db_pool_release(conn_wrapper);
call    0 never executed
    #####:   34:    LOG_INFO("Maintenance log added for Machine %d.", machine_id);
call    0 never executed
    #####:   35:    return true;
        -:   36:}
        -:   37:
function get_maintenance_history called 0 returned 0% blocks executed 0%
    #####:   38:int get_maintenance_history(int machine_id, MaintenanceLog *out_logs, int max_logs) {
    #####:   39:    DBConnection *conn_wrapper = db_pool_acquire();
call    0 never executed
        -:   40:    
    #####:   41:    if (!conn_wrapper) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:   42:        LOG_ERROR("Could not acquire connection to fetch maintenance history.");
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
    #####:   43:        return 0;
        -:   44:    }
        -:   45:    
        -:   46:    char query[256];
    #####:   47:    snprintf(query, sizeof(query),
call    0 never executed
        -:   48:             "SELECT id, machine_id, performer, to_char(ts, 'YYYY-MM-DD'), description, cost "
        -:   49:             "FROM maintenance_logs WHERE machine_id = %d ORDER BY ts DESC;",
        -:   50:             machine_id);
    #####:   51:    PGresult *res = PQexec(conn_wrapper->pg_conn, query);
call    0 never executed
        -:   52:    
    #####:   53:    if (PQresultStatus(res) != PGRES_TUPLES_OK) {
call    0 never executed
branch  1 never executed (fallthrough)
branch  2 never executed
    #####:   54:        LOG_ERROR("Failed to fetch maintenance history: %s", PQerrorMessage(conn_wrapper->pg_conn));
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
call    4 never executed
    #####:   55:        PQclear(res);
call    0 never executed
    #####:   56:        db_pool_release(conn_wrapper);
call    0 never executed
    #####:   57:        return 0;
        -:   58:    }
        -:   59:    
    #####:   60:    int rows = PQntuples(res);
call    0 never executed
    #####:   61:    int count = (rows < max_logs) ? rows : max_logs;
        -:   62:    
    #####:   63:    for (int i = 0; i < count; i++) {
branch  0 never executed
branch  1 never executed (fallthrough)
    #####:   64:        out_logs[i].id = atoi(PQgetvalue(res, i, 0));
call    0 never executed
call    1 never executed
    #####:   65:        out_logs[i].machine_id = atoi(PQgetvalue(res, i, 1));
call    0 never executed
call    1 never executed
    #####:   66:        strncpy(out_logs[i].technician_name, PQgetvalue(res, i, 2), 99);
call    0 never executed
    #####:   67:        out_logs[i].technician_name[99] = '\0';
    #####:   68:        strncpy(out_logs[i].log_date, PQgetvalue(res, i, 3), 31);
call    0 never executed
    #####:   69:        out_logs[i].log_date[31] = '\0';
    #####:   70:        strncpy(out_logs[i].description, PQgetvalue(res, i, 4), 511);
call    0 never executed
    #####:   71:        out_logs[i].description[511] = '\0';
    #####:   72:        out_logs[i].cost = atof(PQgetvalue(res, i, 5));
call    0 never executed
call    1 never executed
        -:   73:    }
        -:   74:    
    #####:   75:    PQclear(res);
call    0 never executed
    #####:   76:    db_pool_release(conn_wrapper);
call    0 never executed
    #####:   77:    LOG_INFO("Fetched %d maintenance logs for Machine %d.", count, machine_id);
call    0 never executed
    #####:   78:    return count;
        -:   79:}
        -:   80:
function get_all_maintenance_logs called 1 returned 100% blocks executed 35%
        1:   81:int get_all_maintenance_logs(MaintenanceLog *out_logs, int max_logs) {
        1:   82:    DBConnection *conn_wrapper = db_pool_acquire();
call    0 returned 1
        -:   83:    
       1*:   84:    if (!conn_wrapper) return 0;
branch  0 taken 0 (fallthrough)
branch  1 taken 1
        -:   85:    
        1:   86:    const char *query = "SELECT id, machine_id, performer, to_char(ts, 'YYYY-MM-DD'), description, cost "
        -:   87:                        "FROM maintenance_logs ORDER BY ts DESC;";
        1:   88:    PGresult *res = PQexec(conn_wrapper->pg_conn, query);
call    0 returned 1
        -:   89:    
        1:   90:    if (PQresultStatus(res) != PGRES_TUPLES_OK) {
call    0 returned 1
branch  1 taken 1 (fallthrough)
branch  2 taken 0
        1:   91:        PQclear(res);
call    0 returned 1
        1:   92:        db_pool_release(conn_wrapper);
call    0 returned 1
        1:   93:        return 0;
        -:   94:    }
        -:   95:    
    #####:   96:    int rows = PQntuples(res);
call    0 never executed
    #####:   97:    int count = (rows < max_logs) ? rows : max_logs;
        -:   98:    
    #####:   99:    for (int i = 0; i < count; i++) {
branch  0 never executed
branch  1 never executed (fallthrough)
    #####:  100:        out_logs[i].id = atoi(PQgetvalue(res, i, 0));
call    0 never executed
call    1 never executed
    #####:  101:        out_logs[i].machine_id = atoi(PQgetvalue(res, i, 1));
call    0 never executed
call    1 never executed
    #####:  102:        strncpy(out_logs[i].technician_name, PQgetvalue(res, i, 2), 99);
call    0 never executed
    #####:  103:        out_logs[i].technician_name[99] = '\0';
    #####:  104:        strncpy(out_logs[i].log_date, PQgetvalue(res, i, 3), 31);
call    0 never executed
    #####:  105:        out_logs[i].log_date[31] = '\0';
    #####:  106:        strncpy(out_logs[i].description, PQgetvalue(res, i, 4), 511);
call    0 never executed
    #####:  107:        out_logs[i].description[511] = '\0';
    #####:  108:        out_logs[i].cost = atof(PQgetvalue(res, i, 5));
call    0 never executed
call    1 never executed
        -:  109:    }
        -:  110:    
    #####:  111:    PQclear(res);
call    0 never executed
    #####:  112:    db_pool_release(conn_wrapper);
call    0 never executed
    #####:  113:    return count;
        -:  114:}
        -:  115:
function update_maintenance_log called 0 returned 0% blocks executed 0%
    #####:  116:bool update_maintenance_log(int log_id, const char *description, double cost) {
    #####:  117:    DBConnection *conn_wrapper = db_pool_acquire();
call    0 never executed
        -:  118:    
    #####:  119:    if (!conn_wrapper) return false;
branch  0 never executed (fallthrough)
branch  1 never executed
        -:  120:    
        -:  121:    char query[1024];
    #####:  122:    snprintf(query, sizeof(query),
call    0 never executed
        -:  123:             "UPDATE maintenance_logs SET description = '%s', cost = %.2f WHERE id = %d;",
        -:  124:             description, cost, log_id);
    #####:  125:    PGresult *res = PQexec(conn_wrapper->pg_conn, query);
call    0 never executed
    #####:  126:    bool success = (PQresultStatus(res) == PGRES_COMMAND_OK);
call    0 never executed
        -:  127:    
    #####:  128:    if (!success) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:  129:        LOG_ERROR("Failed to update log: %s", PQerrorMessage(conn_wrapper->pg_conn));
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
call    4 never executed
        -:  130:    } else {
    #####:  131:        LOG_INFO("Maintenance log %d updated successfully.", log_id);
call    0 never executed
        -:  132:    }
        -:  133:    
    #####:  134:    PQclear(res);
call    0 never executed
    #####:  135:    db_pool_release(conn_wrapper);
call    0 never executed
    #####:  136:    return success;
        -:  137:}
        -:  138:
function delete_maintenance_log called 0 returned 0% blocks executed 0%
    #####:  139:bool delete_maintenance_log(int log_id) {
    #####:  140:    DBConnection *conn_wrapper = db_pool_acquire();
call    0 never executed
        -:  141:    
    #####:  142:    if (!conn_wrapper) return false;
branch  0 never executed (fallthrough)
branch  1 never executed
        -:  143:    
        -:  144:    char query[128];
    #####:  145:    snprintf(query, sizeof(query), "DELETE FROM maintenance_logs WHERE id = %d;", log_id);
call    0 never executed
    #####:  146:    PGresult *res = PQexec(conn_wrapper->pg_conn, query);
call    0 never executed
    #####:  147:    bool success = (PQresultStatus(res) == PGRES_COMMAND_OK);
call    0 never executed
        -:  148:    
    #####:  149:    if (!success) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:  150:        LOG_ERROR("Failed to delete log: %s", PQerrorMessage(conn_wrapper->pg_conn));
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
call    4 never executed
        -:  151:    } else {
    #####:  152:        LOG_INFO("Maintenance log %d deleted.", log_id);
call    0 never executed
        -:  153:    }
        -:  154:    
    #####:  155:    PQclear(res);
call    0 never executed
    #####:  156:    db_pool_release(conn_wrapper);
call    0 never executed
    #####:  157:    return success;
        -:  158:}
        -:  159:
        -:  160:#endif  // TEST_MODE
        -:  161:
        -:  162:#ifdef TEST_MODE
        -:  163:
        -:  164:// =====================================
        -:  165:// MOCK IMPLEMENTATION
        -:  166:// =====================================
        -:  167:
        -:  168:int get_all_maintenance_logs(MaintenanceLog *logs, int max_count) {
        -:  169:    if (!logs || max_count <= 0) return 0;
        -:  170:    
        -:  171:    logs[0].id = 1;
        -:  172:    logs[0].machine_id = 1;
        -:  173:    strcpy(logs[0].technician_name, "Ali");
        -:  174:    strcpy(logs[0].log_date, "2025-01-01");
        -:  175:    strcpy(logs[0].description, "Routine oil change");
        -:  176:    logs[0].cost = 150.5;
        -:  177:    
        -:  178:    return 1;
        -:  179:}
        -:  180:
        -:  181:#endif  // TEST_MODE
