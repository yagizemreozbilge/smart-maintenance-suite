        -:    0:Source:src/backend/tests/unit/database/test_db_connection_real.c
        -:    0:Graph:build_backend_tests/test_db_connection_real-test_db_connection_real.gcno
        -:    0:Data:build_backend_tests/test_db_connection_real-test_db_connection_real.gcda
        -:    0:Runs:1
        -:    1:#include <stdarg.h>
        -:    2:#include <stddef.h>
        -:    3:#include <setjmp.h>
        -:    4:#include <cmocka.h>
        -:    5:#include <string.h>
        -:    6:#include <stdio.h>
        -:    7:#include <stdlib.h>
        -:    8:#include <pthread.h>
        -:    9:
        -:   10:// PostgreSQL'i tamamen devre dışı bırak
        -:   11:#define LIBPQ_FE_H
        -:   12:#define PQconninfoOption void
        -:   13:#define PGconn void
        -:   14:#define PGresult void
        -:   15:#define ConnStatusType int
        -:   16:#define ExecStatusType int
        -:   17:#define CONNECTION_OK 0
        -:   18:#define CONNECTION_BAD 1
        -:   19:#define PGRES_COMMAND_OK 1
        -:   20:#define PGRES_TUPLES_OK 2
        -:   21:#define PGRES_FATAL_ERROR 3
        -:   22:
        -:   23:#include "db_connection.h"
        -:   24:
        -:   25:// Logger mock'ları
function LOG_INFO called 0 returned 0% blocks executed 0%
    #####:   26:void LOG_INFO(const char *format, ...) {}
function LOG_ERROR called 0 returned 0% blocks executed 0%
    #####:   27:void LOG_ERROR(const char *format, ...) {}
        -:   28:
        -:   29:/* ====================================================================
        -:   30: * MOCK FONKSİYONLAR
        -:   31: * ==================================================================== */
        -:   32:
        -:   33:static int mock_connection_status = CONNECTION_OK;
        -:   34:static char mock_error_message[256] = "";
        -:   35:static int mock_connect_fail = 0;
        -:   36:static void* mock_conn_ptr = (void*)0x12345678;
        -:   37:
        -:   38:static int mock_PQconnectdb_called = 0;
        -:   39:static int mock_PQfinish_called = 0;
        -:   40:static int mock_PQstatus_called = 0;
        -:   41:
function PQconnectdb called 11 returned 100% blocks executed 75%
       11:   42:void* PQconnectdb(const char *conninfo) {
       11:   43:    mock_PQconnectdb_called++;
       11:   44:    if (mock_connect_fail) {
branch  0 taken 0 (fallthrough)
branch  1 taken 11
    #####:   45:        return NULL;
        -:   46:    }
       11:   47:    return mock_conn_ptr;
        -:   48:}
        -:   49:
function PQfinish called 11 returned 100% blocks executed 100%
       11:   50:void PQfinish(void *conn) {
       11:   51:    mock_PQfinish_called++;
       11:   52:}
        -:   53:
function PQstatus called 15 returned 100% blocks executed 100%
       15:   54:int PQstatus(const void *conn) {
       15:   55:    mock_PQstatus_called++;
       15:   56:    return mock_connection_status;
        -:   57:}
        -:   58:
function PQerrorMessage called 0 returned 0% blocks executed 0%
    #####:   59:char* PQerrorMessage(const void *conn) {
    #####:   60:    return mock_error_message;
        -:   61:}
        -:   62:
        -:   63:/* ====================================================================
        -:   64: * TEST SETUP
        -:   65: * ==================================================================== */
        -:   66:
function reset_mocks called 5 returned 100% blocks executed 100%
        5:   67:static void reset_mocks(void) {
        5:   68:    mock_connection_status = CONNECTION_OK;
        5:   69:    mock_error_message[0] = '\0';
        5:   70:    mock_connect_fail = 0;
        -:   71:    
        5:   72:    mock_PQconnectdb_called = 0;
        5:   73:    mock_PQfinish_called = 0;
        5:   74:    mock_PQstatus_called = 0;
        5:   75:}
        -:   76:
function setup_default_config called 5 returned 100% blocks executed 100%
        5:   77:static void setup_default_config(DatabaseConfig *cfg) {
        5:   78:    memset(cfg, 0, sizeof(DatabaseConfig));
        5:   79:    strcpy(cfg->host, "localhost");
        5:   80:    cfg->port = 5432;
        5:   81:    strcpy(cfg->dbname, "testdb");
        5:   82:    strcpy(cfg->user, "testuser");
        5:   83:    strcpy(cfg->password, "testpass");
        5:   84:    strcpy(cfg->sslmode, "disable");
        5:   85:    cfg->connect_timeout = 5;
        5:   86:    cfg->pool_min = 2;
        5:   87:    cfg->pool_max = 5;
        5:   88:}
        -:   89:
        -:   90:/* ====================================================================
        -:   91: * TEST CASES
        -:   92: * ==================================================================== */
        -:   93:
function test_pool_init_success called 1 returned 100% blocks executed 100%
        1:   94:static void test_pool_init_success(void **state) {
        1:   95:    reset_mocks();
call    0 returned 1
        -:   96:    
        -:   97:    DatabaseConfig cfg;
        1:   98:    setup_default_config(&cfg);
call    0 returned 1
        -:   99:    
        1:  100:    ConnectionPool *pool = db_pool_init(&cfg, 0, 0);
call    0 returned 1
        1:  101:    assert_non_null(pool);
call    0 returned 1
        -:  102:    
        1:  103:    db_pool_destroy();
call    0 returned 1
        1:  104:}
        -:  105:
function test_acquire_success called 1 returned 100% blocks executed 100%
        1:  106:static void test_acquire_success(void **state) {
        1:  107:    reset_mocks();
call    0 returned 1
        -:  108:    
        -:  109:    DatabaseConfig cfg;
        1:  110:    setup_default_config(&cfg);
call    0 returned 1
        1:  111:    ConnectionPool *pool = db_pool_init(&cfg, 0, 0);
call    0 returned 1
        -:  112:    
        1:  113:    DBConnection *conn = db_pool_acquire();
call    0 returned 1
        1:  114:    assert_non_null(conn);
call    0 returned 1
        -:  115:    
        1:  116:    db_pool_release(conn);
call    0 returned 1
        1:  117:    db_pool_destroy();
call    0 returned 1
        1:  118:}
        -:  119:
function test_acquire_all_and_exhaust called 1 returned 100% blocks executed 100%
        1:  120:static void test_acquire_all_and_exhaust(void **state) {
        1:  121:    reset_mocks();
call    0 returned 1
        -:  122:    
        -:  123:    DatabaseConfig cfg;
        1:  124:    setup_default_config(&cfg);
call    0 returned 1
        1:  125:    cfg.pool_max = 3;
        1:  126:    ConnectionPool *pool = db_pool_init(&cfg, 0, 0);
call    0 returned 1
        -:  127:    
        -:  128:    DBConnection *conns[5];
        -:  129:    
        4:  130:    for (int i = 0; i < cfg.pool_max; i++) {
branch  0 taken 3
branch  1 taken 1 (fallthrough)
        3:  131:        conns[i] = db_pool_acquire();
call    0 returned 3
        3:  132:        assert_non_null(conns[i]);
call    0 returned 3
        -:  133:    }
        -:  134:    
        1:  135:    DBConnection *exhausted = db_pool_acquire();
call    0 returned 1
        1:  136:    assert_null(exhausted);
call    0 returned 1
        -:  137:    
        4:  138:    for (int i = 0; i < cfg.pool_max; i++) {
branch  0 taken 3
branch  1 taken 1 (fallthrough)
        3:  139:        db_pool_release(conns[i]);
call    0 returned 3
        -:  140:    }
        -:  141:    
        1:  142:    db_pool_destroy();
call    0 returned 1
        1:  143:}
        -:  144:
function test_metrics called 1 returned 100% blocks executed 100%
        1:  145:static void test_metrics(void **state) {
        1:  146:    reset_mocks();
call    0 returned 1
        -:  147:    
        -:  148:    DatabaseConfig cfg;
        1:  149:    setup_default_config(&cfg);
call    0 returned 1
        1:  150:    ConnectionPool *pool = db_pool_init(&cfg, 0, 0);
call    0 returned 1
        -:  151:    
        -:  152:    
        1:  153:    PoolMetrics metrics = db_pool_get_metrics();
call    0 returned 1
        -:  154:    
        -:  155:    
        1:  156:    DBConnection *conn = db_pool_acquire();
call    0 returned 1
        1:  157:    assert_non_null(conn);
call    0 returned 1
        -:  158:    
        1:  159:    metrics = db_pool_get_metrics();
call    0 returned 1
        -:  160:    
        1:  161:    printf("\nDEBUG: acquire_cnt=%zu, used_cnt=%d\n", metrics.acquire_cnt, metrics.used_cnt);
call    0 returned 1
        -:  162:    
        -:  163:    
        1:  164:    db_pool_release(conn);
call    0 returned 1
        -:  165:    
        1:  166:    metrics = db_pool_get_metrics();
call    0 returned 1
        1:  167:    printf("DEBUG: release_cnt=%zu, used_cnt=%d\n", metrics.release_cnt, metrics.used_cnt);
call    0 returned 1
        -:  168:    
        1:  169:    db_pool_destroy();
call    0 returned 1
        1:  170:}
        -:  171:
function test_release_null called 1 returned 100% blocks executed 100%
        1:  172:static void test_release_null(void **state) {
        1:  173:    reset_mocks();
call    0 returned 1
        -:  174:    
        -:  175:    DatabaseConfig cfg;
        1:  176:    setup_default_config(&cfg);
call    0 returned 1
        1:  177:    ConnectionPool *pool = db_pool_init(&cfg, 0, 0);
call    0 returned 1
        -:  178:    
        1:  179:    db_pool_release(NULL);
call    0 returned 1
        -:  180:    
        1:  181:    db_pool_destroy();
call    0 returned 1
        1:  182:}
        -:  183:
        -:  184:/* ====================================================================
        -:  185: * MAIN
        -:  186: * ==================================================================== */
        -:  187:
function main called 1 returned 100% blocks executed 100%
        1:  188:int main(void) {
        1:  189:    const struct CMUnitTest tests[] = {
        -:  190:        cmocka_unit_test(test_pool_init_success),
        -:  191:        cmocka_unit_test(test_acquire_success),
        -:  192:        cmocka_unit_test(test_acquire_all_and_exhaust),
        -:  193:        cmocka_unit_test(test_metrics),
        -:  194:        cmocka_unit_test(test_release_null),
        -:  195:    };
        -:  196:    
        1:  197:    return cmocka_run_group_tests(tests, NULL, NULL);
call    0 returned 1
        -:  198:}
