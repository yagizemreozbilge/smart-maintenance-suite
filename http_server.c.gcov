        -:    0:Source:src/backend/api/http_server.c
        -:    0:Graph:C:\Users\yagiz\Desktop\Project\smart-maintenance-suite\build_backend_tests\test_api-http_server.gcno
        -:    0:Data:C:\Users\yagiz\Desktop\Project\smart-maintenance-suite\build_backend_tests\test_api-http_server.gcda
        -:    0:Runs:1
        -:    1:#include "http_server.h"
        -:    2:#include "router.h"
        -:    3:#include "../database/logger.h"
        -:    4:#include <stdio.h>
        -:    5:#include <stdlib.h>
        -:    6:#include <string.h>
        -:    7:#include <stdint.h>
        -:    8:
        -:    9:#ifdef _WIN32
        -:   10:  #include <winsock2.h>
        -:   11:  #pragma comment(lib, "ws2_32.lib")
        -:   12:  typedef int socklen_t;
        -:   13:#else
        -:   14:  #include <unistd.h>
        -:   15:  #include <sys/socket.h>
        -:   16:  #include <netinet/in.h>
        -:   17:  #include <pthread.h>
        -:   18:  #define closesocket close
        -:   19:  #define INVALID_SOCKET -1
        -:   20:  #define SOCKET_ERROR -1
        -:   21:#endif
        -:   22:
        -:   23:static SOCKET server_fd = INVALID_SOCKET;
        -:   24:static bool running = false;
        -:   25:
function parse_request called 0 returned 0% blocks executed 0%
    #####:   26:static void parse_request(const char *buffer, HttpRequest *req) {
    #####:   27:  memset(req, 0, sizeof(HttpRequest));
    #####:   28:  sscanf(buffer, "%s %s", req->method, req->path);
call    0 never executed
    #####:   29:  char *query = strchr(req->path, '?');
        -:   30:
    #####:   31:  if (query) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:   32:    strncpy(req->query_params, query + 1, 511);
    #####:   33:    *query = '\0';
        -:   34:  }
        -:   35:
    #####:   36:  char *body_ptr = strstr(buffer, "\r\n\r\n");
        -:   37:
    #####:   38:  if (body_ptr) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:   39:    strncpy(req->body, body_ptr + 4, 4095);
        -:   40:  }
    #####:   41:}
        -:   42:
function send_modular_response called 0 returned 0% blocks executed 0%
    #####:   43:static void send_modular_response(SOCKET client, HttpResponse *res) {
        -:   44:  char header[1024];
    #####:   45:  const char *status_text = (res->status_code == 200) ? "OK" : (res->status_code == 201 ? "Created" : (res->status_code == 404 ? "Not Found" : "Error"));
branch  0 never executed (fallthrough)
branch  1 never executed
branch  2 never executed (fallthrough)
branch  3 never executed
branch  4 never executed (fallthrough)
branch  5 never executed
    #####:   46:  sprintf(header,
        -:   47:          "HTTP/1.1 %d %s\r\n"
        -:   48:          "Content-Type: %s\r\n"
        -:   49:          "Content-Length: %zu\r\n"
        -:   50:          "Access-Control-Allow-Origin: *\r\n"
        -:   51:          "Access-Control-Allow-Methods: GET, POST, OPTIONS\r\n"
        -:   52:          "Connection: close\r\n\r\n",
    #####:   53:          res->status_code, status_text, res->content_type, strlen(res->body));
call    0 never executed
    #####:   54:  send(client, header, (int)strlen(header), 0);
call    0 never executed
    #####:   55:  send(client, res->body, (int)strlen(res->body), 0);
call    0 never executed
    #####:   56:}
        -:   57:
        -:   58:#ifdef _WIN32
function modular_handle_client called 0 returned 0% blocks executed 0%
    #####:   59:DWORD WINAPI modular_handle_client(LPVOID client_ptr) {
        -:   60:#else
        -:   61:void *modular_handle_client(void *client_ptr) {
        -:   62:#endif
    #####:   63:  SOCKET client_socket = (SOCKET)(uintptr_t)client_ptr;
    #####:   64:  char buffer[8192] = {0};
    #####:   65:  int bytes = recv(client_socket, buffer, sizeof(buffer) - 1, 0);
call    0 never executed
        -:   66:
    #####:   67:  if (bytes > 0) {
branch  0 never executed (fallthrough)
branch  1 never executed
        -:   68:    HttpRequest req;
        -:   69:    HttpResponse res;
    #####:   70:    memset(&res, 0, sizeof(HttpResponse));
    #####:   71:    parse_request(buffer, &req);
call    0 never executed
        -:   72:
        -:   73:    // Handle OPTIONS for CORS
    #####:   74:    if (strcmp(req.method, "OPTIONS") == 0) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:   75:      res.status_code = 200;
    #####:   76:      strcpy(res.content_type, "text/plain");
    #####:   77:      strcpy(res.body, "");
        -:   78:    } else {
    #####:   79:      handle_route(&req, &res);
call    0 never executed
        -:   80:    }
        -:   81:
    #####:   82:    send_modular_response(client_socket, &res);
call    0 never executed
        -:   83:  }
        -:   84:
    #####:   85:  closesocket(client_socket);
call    0 never executed
    #####:   86:  return 0;
        -:   87:}
        -:   88:
        -:   89:#ifdef _WIN32
function modular_server_thread called 0 returned 0% blocks executed 0%
    #####:   90:DWORD WINAPI modular_server_thread(LPVOID param) {
        -:   91:#else
        -:   92:void *modular_server_thread(void *param) {
        -:   93:#endif
        -:   94:
    #####:   95:  while (running) {
branch  0 never executed
branch  1 never executed (fallthrough)
        -:   96:    struct sockaddr_in client;
    #####:   97:    socklen_t c = sizeof(struct sockaddr_in);
    #####:   98:    SOCKET client_socket = accept(server_fd, (struct sockaddr *)&client, &c);
call    0 never executed
        -:   99:
    #####:  100:    if (client_socket != INVALID_SOCKET && running) {
branch  0 never executed (fallthrough)
branch  1 never executed
branch  2 never executed (fallthrough)
branch  3 never executed
        -:  101:#ifdef _WIN32
    #####:  102:      CreateThread(NULL, 0, modular_handle_client, (LPVOID)(uintptr_t)client_socket, 0, NULL);
call    0 never executed
        -:  103:#else
        -:  104:      pthread_t thread;
        -:  105:      pthread_create(&thread, NULL, modular_handle_client, (void *)(uintptr_t)client_socket);
        -:  106:      pthread_detach(thread);
        -:  107:#endif
    #####:  108:    } else if (client_socket != INVALID_SOCKET) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:  109:      closesocket(client_socket);
call    0 never executed
        -:  110:    }
        -:  111:  }
        -:  112:
    #####:  113:  return 0;
        -:  114:}
        -:  115:
function start_http_server called 0 returned 0% blocks executed 0%
    #####:  116:bool start_http_server(int port) {
        -:  117:#ifdef _WIN32
        -:  118:  WSADATA wsa;
        -:  119:
    #####:  120:  if (WSAStartup(MAKEWORD(2, 2), &wsa) != 0) return false;
call    0 never executed
branch  1 never executed (fallthrough)
branch  2 never executed
        -:  121:
        -:  122:#endif
    #####:  123:  server_fd = socket(AF_INET, SOCK_STREAM, 0);
call    0 never executed
        -:  124:
    #####:  125:  if (server_fd == INVALID_SOCKET) return false;
branch  0 never executed (fallthrough)
branch  1 never executed
        -:  126:
        -:  127:  struct sockaddr_in server;
    #####:  128:  server.sin_family = AF_INET;
    #####:  129:  server.sin_addr.s_addr = INADDR_ANY;
    #####:  130:  server.sin_port = htons(port);
call    0 never executed
    #####:  131:  int opt = 1;
    #####:  132:  setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, (const char *)&opt, sizeof(opt));
call    0 never executed
        -:  133:
    #####:  134:  if (bind(server_fd, (struct sockaddr *)&server, sizeof(server)) == SOCKET_ERROR) {
call    0 never executed
branch  1 never executed (fallthrough)
branch  2 never executed
    #####:  135:    closesocket(server_fd);
call    0 never executed
    #####:  136:    return false;
        -:  137:  }
        -:  138:
    #####:  139:  listen(server_fd, 10);
call    0 never executed
    #####:  140:  running = true;
        -:  141:#ifdef _WIN32
    #####:  142:  CloseHandle(CreateThread(NULL, 0, modular_server_thread, NULL, 0, NULL));
call    0 never executed
call    1 never executed
        -:  143:#else
        -:  144:  pthread_t thread;
        -:  145:  pthread_create(&thread, NULL, modular_server_thread, NULL);
        -:  146:  pthread_detach(thread);
        -:  147:#endif
    #####:  148:  LOG_INFO("Modular HTTP Server running on port %d", port);
call    0 never executed
    #####:  149:  return true;
        -:  150:}
        -:  151:
function stop_http_server called 0 returned 0% blocks executed 0%
    #####:  152:void stop_http_server(void) {
    #####:  153:  running = false;
        -:  154:
    #####:  155:  if (server_fd != INVALID_SOCKET) closesocket(server_fd);
branch  0 never executed (fallthrough)
branch  1 never executed
call    2 never executed
        -:  156:
        -:  157:#ifdef _WIN32
    #####:  158:  WSACleanup();
call    0 never executed
        -:  159:#endif
    #####:  160:}
