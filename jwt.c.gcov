        -:    0:Source:src/backend/security/jwt.c
        -:    0:Graph:build_backend_tests/test_auth_handler-jwt.gcno
        -:    0:Data:build_backend_tests/test_auth_handler-jwt.gcda
        -:    0:Runs:1
        -:    1:#include "jwt.h"
        -:    2:#include "db_connection.h"
        -:    3:#include "logger.h"
        -:    4:#include <stdio.h>
        -:    5:#include <string.h>
        -:    6:#include <stdlib.h>
        -:    7:#include <time.h>
        -:    8:
        -:    9:// Basit bir Secret Key - Gerçek projelerde bu .env dosyasında olur
        -:   10:#define APP_SECRET_KEY "maintenance_secret_2026"
        -:   11:
function generate_auth_token called 1 returned 100% blocks executed 100%
        1:   12:char *generate_auth_token(int user_id, const char *username, const char *role) {
        1:   13:  char *token = (char *)malloc(128);
        1:   14:  time_t now = time(NULL);
call    0 returned 1
        1:   15:  long expires = (long)now + (3600 * 24); // 24 saat geçerli
        -:   16:  // Student-style "Homemade" JWT: user:role:expires:hash
        -:   17:  // Daha sonra bunu base64 yaparak daha şık hale getirebiliriz.
        1:   18:  snprintf(token, 128, "token_%d_%ld_%s", user_id, expires, role);
call    0 returned 1
        1:   19:  return token;
        -:   20:}
        -:   21:
function verify_user_credentials called 0 returned 0% blocks executed 0%
    #####:   22:int verify_user_credentials(const char *username, const char *password, char *out_role) {
    #####:   23:  DBConnection *conn_wrapper = db_pool_acquire();
call    0 never executed
        -:   24:
    #####:   25:  if (!conn_wrapper) return -1;
branch  0 never executed (fallthrough)
branch  1 never executed
        -:   26:
        -:   27:  char query[512];
    #####:   28:  snprintf(query, sizeof(query),
call    0 never executed
        -:   29:           "SELECT id, role FROM users WHERE username = '%s' AND password_hash = '%s';",
        -:   30:           username, password);
    #####:   31:  PGresult *res = PQexec(conn_wrapper->pg_conn, query);
call    0 never executed
        -:   32:
    #####:   33:  if (PQresultStatus(res) != PGRES_TUPLES_OK || PQntuples(res) == 0) {
call    0 never executed
branch  1 never executed (fallthrough)
branch  2 never executed
call    3 never executed
branch  4 never executed (fallthrough)
branch  5 never executed
    #####:   34:    LOG_ERROR("Login failed for user: %s", username);
call    0 never executed
call    1 never executed
call    2 never executed
call    3 never executed
    #####:   35:    PQclear(res);
call    0 never executed
    #####:   36:    db_pool_release(conn_wrapper);
call    0 never executed
    #####:   37:    return -1;
        -:   38:  }
        -:   39:
    #####:   40:  int uid = atoi(PQgetvalue(res, 0, 0));
call    0 never executed
call    1 never executed
        -:   41:
    #####:   42:  if (out_role) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:   43:    strncpy(out_role, PQgetvalue(res, 0, 1), 19);
call    0 never executed
    #####:   44:    out_role[19] = '\0';
        -:   45:  }
        -:   46:
    #####:   47:  PQclear(res);
call    0 never executed
    #####:   48:  db_pool_release(conn_wrapper);
call    0 never executed
    #####:   49:  LOG_INFO("User %s (ID: %d) successfully logged in.", username, uid);
call    0 never executed
    #####:   50:  return uid;
        -:   51:}
        -:   52:
function validate_auth_token called 0 returned 0% blocks executed 0%
    #####:   53:bool validate_auth_token(const char *token_str) {
    #####:   54:  if (!token_str || strlen(token_str) < 10) return false;
branch  0 never executed (fallthrough)
branch  1 never executed
branch  2 never executed (fallthrough)
branch  3 never executed
        -:   55:
        -:   56:  // Basit validation: "token_" ile başlamalı
    #####:   57:  if (strncmp(token_str, "token_", 6) == 0) {
branch  0 never executed (fallthrough)
branch  1 never executed
    #####:   58:    return true;
        -:   59:  }
        -:   60:
    #####:   61:  return false;
        -:   62:}
